name: "Build Terra"
description: "Build and package Terra service"
inputs:
  service:
    required: true
    description: "Service folder name (e.g., Lobby)"
  environment:
    required: false
    description: "Environment tag for the Docker image (e.g., prod, dev)"
    default: "prod"
outputs:
  image:
    value: ${{ steps.meta.outputs.image }}
    description: "The built Docker image with tag"
runs:
  using: "composite"
  steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log into GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ env.GITHUB_TOKEN }}

    - name: Extract Docker metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ghcr.io/${{ github.repository }}/${{ inputs.service }}

    - name: Calculate scripts checksum
      id: checksum
      shell: bash
      run: |
        chmod +x ./Zrvr/scripts/external/calculate-checksum.sh
        SCRIPTS_CHECKSUM=$(./Zrvr/scripts/external/calculate-checksum.sh)
        echo "SCRIPTS_CHECKSUM=$SCRIPTS_CHECKSUM" >> $GITHUB_ENV

    - name: Build and push Docker image
      id: build-and-push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Zrvr/Dockerfile
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        build-args: |
          APP_PATH=./${{ inputs.service }}
          MINECRAFT_VERSION=${{ inputs.mcversion }}
          TYPE=${{ inputs.type }}
          SCRIPTS_CHECKSUM=${{ env.SCRIPTS_CHECKSUM }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
